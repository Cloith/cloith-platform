---
- name: Pre-flight SSH Authentication Check
  hosts: all
  gather_facts: false
  tasks:
    - name: "Attempt SSH and catch Tailscale Auth URL"
      # We use 'local_action' because we want the SSH command 
      # to run from the Manager, not the remote VPS.
      local_action:
        module: ansible.builtin.command
        # We try to run a simple 'true' command. 
        # If Tailscale blocks it, this command will return the URL in stderr.
        cmd: "ssh -o ConnectTimeout=5 {{ ansible_user }}@{{ inventory_hostname }} '/usr/bin/true'"
      register: ssh_check
      # We tell Ansible NOT to fail immediately if it's blocked
      ignore_errors: true
      changed_when: false

    - name: "Display Authentication Link if blocked"
      debug:
        msg: 
          - "⚠️ TAILSCALE AUTH REQUIRED ⚠️"
          - "Your security policy requires manual approval for root access."
          - "Please open this link and sign in:"
          - "{{ ssh_check.stderr | regex_search('https://login.tailscale.com/a/[a-zA-Z0-9]+') }}"
      # Only show this if the word 'https://login.tailscale.com' is in the error
      when: 
        - ssh_check.failed
        - "'https://login.tailscale.com' in ssh_check.stderr"

    - name: "Wait for user to click the link"
      pause:
        prompt: "Once you have signed in at the link above, press ENTER to continue..."
      when: 
        - ssh_check.failed
        - "'https://login.tailscale.com' in ssh_check.stderr"